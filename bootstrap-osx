#!/usr/bin/env zsh

[ -d /usr/local/Cellar ] ||
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

[ -d /usr/local/Library/Taps/homebrew/homebrew-dupes ] ||
  brew tap homebrew/dupes

brew update

for formula in \
  brew-gem \
  curl git gh gnupg2 psgrep pstree pv tree watch wget \
  apple-gcc42 automake autoconf \
  mysql \
  postgresql geos postgis geoip \
  redis \
  node \
  ffmpeg \
  rbenv rbenv-default-gems rbenv-communal-gems rbenv-gem-rehash rbenv-vars ruby-build \
  imagemagick json-c libffi libmaxminddb sqlite3 exiv2; do

  [ -d "$(brew --prefix $formula)" ] ||
    brew install $formula

done

eval "$(rbenv init -)"

mkdir -p ~/.rbenv/cache

for gem in gem-open bundler foreman; do
  if ! grep -q $gem $(rbenv root)/default-gems; then
    echo $gem >> ~/.rbenv/default-gems
  fi
done

[ -d ~/.rbenv/versions/2.1.2 ] ||
  rbenv install 2.1.2

rbenv global 2.1.2

for version in \
  1.8.7-p375 1.9.3-p547 2.0.0-p481 \
  jruby-1.6.8 jruby-1.7.12 \
  rbx-1.2.4 rbx-2.2.6; do

  [ -d ~/.rbenv/versions/$version ] ||
    rbenv install $version

  # Sometimes the hook fails, do it again
  rbenv communize $version

done
