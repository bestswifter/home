#!/bin/bash

pushd $HOME

  if [[ "$(uname -s)" = "Darwin" ]]; then
    if ! xcode-select --print-path > /dev/null; then
      echo "Requesting install for Command Line Tools, press ENTER to continue."
      /usr/bin/xcode-select --install
      read
    fi

    if git --version | grep -vq license; then
      echo "You need to accept the Xcode license, press ENTER to continue."
      read
      sudo xcodebuild -license
    fi
  fi

  if [[ -e $HOME/.home ]]; then
    pushd $HOME/.home
      git pull
      git submodule update --init --recursive
    popd
  else
    git clone --recursive https://github.com/sj26/home .home
  fi

  pushd .home
    for bundle in camelcasemotion textobj-function textobj-user; do
      if ! grep -q doc/tags .git/modules/.vim/bundle/$bundle/info/exclude; then
        echo doc/tags >> .git/modules/.vim/bundle/$bundle/info/exclude
      fi
    done

    if [[ ! -e .vim/bundle/ctrlp-cmatcher/autoload/fuzzycomt.so ]]; then
      pushd .vim/bundle/ctrlp-cmatcher
      ./install.sh
      popd
    fi
  popd

  for file in .ackrc .bin .gemrc .gitconfig .js .pryrc .railsrc .tmux.conf .vim .zsh; do
    [[ -L $file ]] || ln -fs .home/$file
  done
  for file in .config/git/{ignore,attributes}; do
    mkdir -p "${file%/*}" && [ -L "$file" ] || ln -fs "$HOME/.home/$file" "$HOME/$file"
  done
  for suffix in rc; do
    [[ -L .vim$suffix ]] || ln -fs .vim/$suffix .vim$suffix
  done
  for suffix in env profile rc; do
    [[ -L .zsh$suffix ]] || ln -fs .zsh/$suffix .zsh$suffix
  done

  [[ "$(uname -s)" = "Darwin" ]] && .home/move-in-osx

popd
